《从0开始学架构》- 李运华 读书笔记


### 负载均衡：

- DNS(地理级别)
- 硬件(集群级别)
- 软件(机器级别)

### CAP 理论：

在一个分布式系统（指相互连接并共享数据的节点的集合）中，当涉及读写操作时，
只能保证一致性(Consistence)，可用性(Availability)，分区容错性(Partition Tolerance)三者中两个，另外一个必须牺牲。

- 一致性(C): 对某个指定的客户端来说，读操作保证能够返回最新的写操作结果
- 可用性(A)：非故障的节点在合理的时间内返回合理的响应（不是错误和超时的响应）
- 分区容忍性(P)：当出现网络分区后，系统能够继续『履行职责』（丢包、连接中断、拥塞等导致网络分区）

必须选择 P 因为网络无法100%可靠。如果我们选择了 CA 放弃了 P，发生分区现象时，为了保证 C
就得禁止写入，有写入请求时候系统返回 Error，这又和 A 冲突了。
所以分布式系统理论上只能用(保证 CA 发生 P 的时候矛盾)，只能选择AP/AP。

![CAP](./CAP.png)

- CP: 当发生分区后， N1节点已经更新数据到 y，但是 N1和 N2 复制通道中断了，N2还是 x。
  这时client 访问 N2时，N2需要返回 Error，提示客户端系统发生了错误。违背了可用性要求
- AP: 还是上一种场景但是 N2 直接返回了老的数据 x，虽然不正确确是一个合理的结果，违背了 C。


### CAP 细节：

- 关注的粒度是数据，不是整个系统。需要根据不同应用场景和要求来设计，每类数据用不同策略。
- CAP是忽略网络延迟的。布鲁尔定义一致性没考虑复制延迟，而现实中复制总是需要花费时间的。
  C不可能完美实现，总会有延迟，数据复制过程中不一致，
- 正常运行情况下，不存在CP和 AP 的选择，可以同时 CA。分区没发生的时候可以考虑 CA。
- 放弃不等于什么都不做，需要未分区恢复后做准备，牺牲只是说分区过程中无法保证 C or
  A。可以在分区之间进行一些操作，从而让分区故障解决后，系统重新达到 CA 的状态。

### ACID

ACID 是为了保证数据库事务的正确性提出来的一个理论。

- Atomicity（原子性）

一个事务中的所有操作，要么全部完成，要么全部不完成，不会在中间某个环节结束。事务在执行过程中发生错误，会被回滚到事务开始前的状态，就像这个事务从来没有执行过一样。

- Consistency（一致性）

在事务开始之前和事务结束以后，数据库的完整性没有被破坏。

- Isolation（隔离性）

数据库允许多个并发事务同时对数据进行读写和修改的能力。隔离性可以防止多个事务并发执行时由于交叉执行而导致数据的不一致。事务隔离分为不同级别，包括读未提交（Read uncommitted）、读提交（read committed）、可重复读（repeatable read）和串行化（Serializable）。

- Durability（持久性）

事务处理结束后，对数据的修改就是永久的，即便系统故障也不会丢失。

### BASE

- BA(Baciscally Available): 基本可用。分布式系统发生故障，允许损失部分可用性，保证核心可用
- S(Soft State): 软状态。允许中间状态，该中间状态不会影响系统整体可用性。（这里的中间状态就是 CAP 中数据不一致）
- E(Eventual Consistency): 最终一致性。系统中的所有数据副本一定时间后，最终能够达到一致的状态。

核心思想是如果无法做到强一致性(CAP中的一致性就是强一致性)，应用适当的方式达到最终一致性，对 AP 的一种补充。

- CAP 是忽略延时的，实际场景无法避免(完美的 CP 不存在)
- AP 牺牲一致性只是指分区期间，而不是永远放弃一致性

ACID 是数据库事务完整性的理论，CAP 是分布式设计理论，BASE 是 CAP 中 AP 方案的延伸。


### FMEA，排除架构可用性隐患

FMEA(Failure mode and effects analysis, 故障模式与影响分析)

- 给出初始的架构设计图
- 假设架构中某个部件故障
- 分析故障对系统功能的影响
- 分居分析结构判断是否需要优化

FMEA 分析表：

- 功能点。从用户角度看
- 故障模式。故障点和故障形式，尽量精确描述
- 故障影响。功能点受到的具体影响
- 严重程度。业务角度，致命/高/中/低/无
- 故障原因。
- 故障概率。高中低。硬件、开源系统、自研系统
- 风险程度，综合严重程度和故障概率判断最终等级。风险程度=严重程度x故障概率
- 已有措施。报警、 容错、自恢复
- 规避措施。技术手段和管理手段
- 解决措施：技术手段
- 后续计划：哪些还缺少应对措施，根据优先级排序提出后续解决计划

# 双机架构

### 主备复制

备机只起到备份作用，不承担实际读写操作。需要人工干预把备机改为主机。后台管理系统用得多

### 主从复制

主写从读。可能出现数据不一致问题，故障要人工干预。适合写少读多，论坛、BBS、新闻网站等

### 双机切换
主备切换和主从切换

常见架构：

- 互连式：主备机直接建立状态传递的渠道
- 中介式：主备机都去连接中介，通过中介传递状态信息。mongodb 的 Replica set。成熟的中介式方案：ZooKeeper/Keepalived
- 模拟式：备机模拟成客户端，向主机发起模拟的读写操作，根据读写操作的响应情况判断主机状态。

### 主主复制

需要保证数据能双向复制，但是很多无法做到，用户 id，库存，余额等。一般是临时、可丢失可覆盖的数据场景


# 集群和分区

### 数据集群
- 数据集中集群。ZooKeeper ZAB算法
- 数据分散集群。均衡性、容错性、可伸缩性。Hadoop Namenode。Elasticsearch
  集群通过选举一台服务器来做数据分区的分配，masternode

### 数据分区

按照一定规则分区，不同分区放在不同地理位置。考虑因素

- 数据量
- 分区规则
- 复制规则，集中式、互备式、独立式

# 如何设计计算高可用架构
