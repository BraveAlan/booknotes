# 1. 山重复疑无路

有效的调试步骤：

- 弄清楚为什么运行异常
- 修复问题
- 避免破坏其他部分
- 保持或者提高代码总体质量（可读性，架构，测试覆盖，性能等）
- 确保同样问题不要再次发生

实证方法：构建实验，观察结果

核心调试过程：

- 问题重现
- 问题诊断
- 缺陷修复
- 反思，吸取教训

澄清问题：

- 发生了什么，应该发生什么
- 一次一个问题
- 先检查简单的事情


# 2  重现问题

### 2.1 重现第一，提问第二

如何重现：

- 明确开始要做得事情（比如缺陷报告的步骤）
- 抓住重点

控制因素：

- 软件本身
- 运行环境
- 提供的输入

### 2.2 控制软件

### 2.3 控制环境

可能包含所有环境

### 2.4 控制输入

推测可能输入:

- 回溯工作
- 探测可能输入值
  - 边界分析
  - 分之覆盖
  - 利用错误条件
  - 引入随机性：模糊测试；生成模糊器；变异模糊器
- 记录输入值
  - 日志框架。可以开启 or 关闭；日志级别；上下文（代码行数等）；分析工具（ELK）
  - 外部日志。代理服务器等
- 负载和压力。有些缺陷只有在某种压力才表现出来（高负载网络流量，有限的可用内存）

### 2.5 改进问题重现

##### 2.5.1 最小化反馈周期。编辑-编辑-执行-重新问题时间最短

- 尽可能简单，通过二分法快速定位
- 自动化最小输入
- 最大限度减少所需时间，比如营造资源耗尽的局面。

##### 2.5.2 不确定缺陷变为确定

软件之美在于确定性，但是不确定性从哪里来？

- 开始于不可预知的初始状态。从未经初始化的内存读取数据(强制初始化，或者内存完整性检测软件)
- 与外部系统交互: 精确控制从外部系统接收了什么
- 故意使用随机性: 伪随机数
- 多线程: 通过 sleep 等增加出现竞争的可能性

##### 2.5.3 自动化

- 自动化测试
- 重放日志

### 2.6 无法重现怎么办

- 缺陷真的存在么？
- 在相同区域解决不同问题
- 让其他人参与其中。不同人的视角
- 充分利用用户群体
- 推测法：逻辑推理，想象出错的可能性


# 3 诊断

### 3.1 不要急于动手，试试科学方法

- 调试方法：
  - 根据你对软件运行情况的理解，提出一个可以导致这种情况的假设
  - 设计一个实验，证明假设是否正确
  - 如果无法证明你的假设，重新设计然后再次实验
  - 如果实验支持你的假设，继续证明，知道能够证明或者证伪

- 实验必须起到验证的作用。(与他人争辩试图推翻你的假设)

- 每次只做一个修改。多处修改可能导致错误的结论。

- 记录你做的调试。定期回顾你已经尝试过的实验和学到的东西，使用日记簿或者电子笔记。

- 不要忽略任何细节。凡是你不明白的都是潜在的缺陷。(Anything that you don't understand is potentially a bug)
  - 写出假设。曾经做过的假设写到纸上
  - 可以跟踪详细信息
  - 确保不会忘记需要做的事情
  - 短暂休息，可以尝试头脑风暴

### 3.2 相关策略

##### 3.2.1 插桩
使用日志，但是不要引入额外的副作用影响了原始代码逻辑

##### 3.2.2 分而治之
二分法，排除一部分模块或者代码的问题。

##### 3.2.3 源码控制工具
git 找出历史提交，分析引入缺陷的提交

##### 3.2.4 聚焦差异
找到特殊用例，缺陷的边界

##### 3.2.5 向他人学习
网络搜索，同事求助

##### 3.2.6 奥卡姆剃刀
其他条件相同情况下，最简单的解释是最好的。

### 3.3 调试器

代码检查，断点，单步调试，检查运行状态

- 开发初期调试器非常有用
- 让代码以特定方式运行
- 探究看不懂的代码

随着经验增加和TDD 思想出现，调试器使用会变少

### 3.4 陷阱

- 你做的修改是正确的么？如果没有，说明你没修改到点子上。尝试引入明显的失败比如断言让其暴露出来
- 验证假设。思维定势造成的先验假设可能会让你得不到结果
- 多重原因。问题有时候是复杂的，
  - 对问题进行隔离，找到一个方法重现缺陷。
  - 先找同一个区域内其他较明显的缺陷，扫清障碍，让缺陷更加明显
- 查出变化并且控制它。第三方系统或者数据库。

### 3.5 思维游戏

- 旁观调试法（小黄鸭）。求助其他人。倾听；提问；留意没有探究过的地方；了解接下来将会发生什么。解释问题会帮你理清思路
- 角色扮演
- 换换脑筋。潜意识帮助你
- 做些改变，什么改变都行
- 福尔摩斯原则：当你排除了一切不可能之后，无论它多么不可思议，它也一定是真相

### 3.6 验证诊断

- 向其他人解释你的诊断
- 检查源代码原始副本
- 多和其他人讨论，并假设你是错的


# 4 修复缺陷
